"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _matchClass(t,e){if(t&&t.length&&e&&e.length){if(1==t.length&&1==e.length)return t[0]==e[0];if(t.length<e.length)return!1;var n=!0,r=!1,i=void 0;try{for(var s,a=e[Symbol.iterator]();!(n=(s=a.next()).done);n=!0){var l=s.value,h=!1,o=!0,u=!1,c=void 0;try{for(var f,d=t[Symbol.iterator]();!(o=(f=d.next()).done);o=!0){f.value==l&&(h=!0)}}catch(t){u=!0,c=t}finally{try{!o&&d.return&&d.return()}finally{if(u)throw c}}if(0==h)return!1}}catch(t){r=!0,i=t}finally{try{!n&&a.return&&a.return()}finally{if(r)throw i}}return!0}return!1}function _matchId(t,e){if(!(t&&t.length&&e&&e.length))return!1;if(1==t.length&&1==e.length)return t[0]==e[0];if(t.length<e.length)return!1;var n=!0,r=!1,i=void 0;try{for(var s,a=e[Symbol.iterator]();!(n=(s=a.next()).done);n=!0){var l=s.value,h=!1,o=!0,u=!1,c=void 0;try{for(var f,d=t[Symbol.iterator]();!(o=(f=d.next()).done);o=!0){f.value==l&&(h=!0)}}catch(t){u=!0,c=t}finally{try{!o&&d.return&&d.return()}finally{if(u)throw c}}if(0==h)return!1}}catch(t){r=!0,i=t}finally{try{!n&&a.return&&a.return()}finally{if(r)throw i}}return!0}function matchClass(t,e,n,r){if("*"==r)return 0;var i=r.match(/^[^\.#\[\]\s]+/),s=r.match(/\.[^\.#\[\]\s]+/g),a=r.match(/#[^\.#\[\]\s]+/g);return a?_matchId(n,a)?s&&!_matchClass(e,s)||i&&t!=i[0]?-1:2:-1:s?_matchClass(e,s)?i&&t!=i[0]?-1:1:-1:i&&t==i[0]?0:-1}var _createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),config=require("./config.js"),CssHandler=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,t),this.styles=Object.assign({},e)}return _createClass(t,[{key:"getStyle",value:function(t){var e="";return t=t.replace(/<[sS][tT][yY][lL][eE][\s\S]*?>([\s\S]*?)<\/[sS][tT][yY][lL][eE][\s\S]*?>/g,function(){return e+=arguments[1],""}),this.styles=new CssParser(e,this.styles).parse(),t}},{key:"parseCss",value:function(t){return new CssParser(t,{},!0).parse()}},{key:"match",value:function(t,e,n){var r=[];if(e.class){var i=e.class.split(/\s/),s=!0,a=!1,l=void 0;try{for(var h,o=i[Symbol.iterator]();!(s=(h=o.next()).done);s=!0){var u=h.value;r.push("."+u)}}catch(t){a=!0,l=t}finally{try{!s&&o.return&&o.return()}finally{if(a)throw l}}}var c=[];if(e.id){var i=e.id.split(/\s/),f=!0,d=!1,y=void 0;try{for(var v,_=i[Symbol.iterator]();!(f=(v=_.next()).done);f=!0){var u=v.value;c.push("#"+u)}}catch(t){d=!0,y=t}finally{try{!f&&_.return&&_.return()}finally{if(d)throw y}}}var g,p,m="",S="",C="",k=!1;n.i=[],n.index=[],n.pseudo=[];for(var u=0;u<this.styles.length;u++){p=this.styles[u],">"==p.key[0]?(g=p.key.substring(1),k=!0):(g=p.key,k=!1);var x=matchClass(t,r,c,g);-1!=x&&(p.hasOwnProperty("index")&&p.index!=p.list.length-1?(n.i.push(u),n.index.push(p.index),p.index++,p.key=p.list[p.index]):p.pseudo?n.pseudo.push(p):0==x?m+=";"+p.content:1==x?S+=";"+p.content:C+=";"+p.content),k&&(n.i.push(u),n.index.push(p.index),p.index--,p.key=p.list[p.index])}return n.i.length||(delete n.i,delete n.index),n.pseudo.length||delete n.pseudo,(m?m+";":"")+(S?S+";":"")+(C?C+";":"")}},{key:"pop",value:function(t){if(t.hasOwnProperty("i")){for(var e=0;e<t.i.length;e++)this.styles[t.i[e]].key=this.styles[t.i[e]].list[t.index[e]],this.styles[t.i[e]].index=t.index[e];delete t.i,delete t.index}if(t.hasOwnProperty("pseudo")){var n=!0,r=!1,i=void 0;try{for(var s,a=t.pseudo[Symbol.iterator]();!(n=(s=a.next()).done);n=!0){var l,h=s.value,o=h.content.replace(/content\s*:\s*['"]([\S]*?)['"];*/,function(){return l=arguments[1],""}),u={name:"span",attrs:{style:o},children:[{type:"text",text:l}]};"before"==h.pseudo?t.children.unshift(u):t.children.push(u)}}catch(t){r=!0,i=t}finally{try{!n&&a.return&&a.return()}finally{if(r)throw i}}}}}]),t}(),CssParser=function(){function t(e,n,r){_classCallCheck(this,t),this.data=e,this.res=this.merge(n,r),this._floor=0,this._i=0,this._name="",this._content="",this._sectionStart=0,this._stateHandler=this.SpaceHandler}return _createClass(t,[{key:"merge",value:function(t,e){if(!e)for(var n in config.userAgentStyles)t[n]?t[n]=config.userAgentStyles[n]+";"+t[n]:t[n]=config.userAgentStyles[n];var r=[];for(var i in t)r.push({key:i,content:t[i]});return r}},{key:"parse",value:function(){for(;this._i<this.data.length;this._i++)this._stateHandler(this.data[this._i]);return this.res}},{key:"SpaceHandler",value:function(t){"."==t||"#"==t||t>="a"&&t<="z"||t>="A"&&t<="Z"?(this._sectionStart=this._i,this._stateHandler=this.StyleNameHandler):"/"==t&&"*"==this.data[this._i+1]?this.CommentHandler():config.blankChar[t]||";"==t||(this._stateHandler=this.IgnoreHandler)}},{key:"CommentHandler",value:function(){this._i=this.data.indexOf("*/",this._i)+1,-1==this._i&&(this._i=this.data.length),this._stateHandler=this.SpaceHandler}},{key:"IgnoreHandler",value:function(t){"{"==t?this._floor++:"}"==t&&--this._floor<=0&&(this._stateHandler=this.SpaceHandler)}},{key:"StyleNameHandler",value:function(t){"{"==t?(this._name=this.data.substring(this._sectionStart,this._i),this._sectionStart=this._i+1,this.ContentHandler()):config.blankChar[t]?(this._name=this.data.substring(this._sectionStart,this._i),this._stateHandler=this.NameSpaceHandler):"["==t&&(this._stateHandler=this.IgnoreHandler)}},{key:"NameSpaceHandler",value:function(t){"{"==t?(this._sectionStart=this._i+1,this.ContentHandler()):config.blankChar[t]||(this._stateHandler=this.StyleNameHandler)}},{key:"ContentHandler",value:function(){this._i=this.data.indexOf("}",this._i),-1==this._i&&(this._i=this.data.length);for(var t=this.data.substring(this._sectionStart,this._i).trim(),e=t.length,n=[t[--e]];--e>0;)config.blankChar[t[e]]&&config.blankChar[n[0]]||(";"!=t[e]&&":"!=t[e]||!config.blankChar[n[0]]?n.unshift(t[e]):n[0]=t[e]);n.unshift(t[0]),this._content=n.join("");var r=this._name.split(/\s*,\s*/),i=!0,s=!1,a=void 0;try{for(var l,h=r[Symbol.iterator]();!(i=(l=h.next()).done);i=!0){var o=l.value;this.setClass(o)}}catch(t){s=!0,a=t}finally{try{!i&&h.return&&h.return()}finally{if(s)throw a}}this._stateHandler=this.SpaceHandler}},{key:"setClass",value:function(t){var e;if(t.includes(":")){var n=t.split(/\s*:+\s*/);if(t=n[0],"before"!=(e=n[1])&&"after"!=e)return}/[\s>]/.test(t)?(t=t.replace(/\s*>\s*/g," >").split(/\s/),this.res.push({key:t[0],index:0,list:t,content:this._content,pseudo:e})):this.res.push({key:t,content:this._content,pseudo:e})}}]),t}();module.exports=CssHandler;